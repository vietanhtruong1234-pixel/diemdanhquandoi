<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Điểm danh (Firebase Realtime DB)</title>
  <style>
    :root{--primary:#0066ff;--muted:#6b7280}
    body{font-family:Inter,system-ui,Arial;padding:18px;background:#f6f8fb}
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(2,6,23,0.06);margin-bottom:12px}
    input,button,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;margin-top:6px}
    button{background:var(--primary);color:#fff;border:0;cursor:pointer}
    .row{display:flex;gap:8px}
    .col{flex:1}
    .small{font-size:13px;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #f3f6fa;text-align:left;font-size:13px}
    @media(max-width:720px){ .row{flex-direction:column} }
  </style>
</head>
<body>

  <h2>Hệ thống điểm danh (Firebase Realtime Database)</h2>

  <div id="authBox" class="card">
    <h3>Đăng ký / Đăng nhập</h3>
    <div id="authMsg" class="small"></div>

    <div id="regArea">
      <label>Email</label>
      <input id="regEmail" type="email" placeholder="email@vd.com" />
      <label>Mật khẩu</label>
      <input id="regPass" type="password" placeholder="Mật khẩu" />
      <label>Họ tên (hiển thị)</label>
      <input id="regName" placeholder="Nguyễn Văn A" />
      <button onclick="register()">Đăng ký</button>
    </div>

    <hr />

    <div id="loginArea">
      <label>Email</label>
      <input id="logEmail" type="email" placeholder="email" />
      <label>Mật khẩu</label>
      <input id="logPass" type="password" placeholder="Mật khẩu" />
      <div class="row">
        <div class="col"><button onclick="login()">Đăng nhập</button></div>
        <div class="col"><button style="background:#374151" onclick="logout()">Đăng xuất</button></div>
      </div>
    </div>
  </div>

  <div id="userBox" class="card" style="display:none">
    <h3>Điểm danh</h3>
    <p id="welcome" class="small"></p>
    <div class="row">
      <div class="col"><button onclick="checkIn()">Điểm danh ngay</button></div>
      <div class="col"><button style="background:#10b981" onclick="myAttendance()">Xem lịch sử</button></div>
    </div>
    <p id="attMsg" class="small"></p>
    <ul id="myList" class="small"></ul>
  </div>

  <div id="adminBox" class="card" style="display:none">
    <h3>Admin — Danh sách điểm danh</h3>
    <div class="row">
      <div class="col"><button onclick="loadAllAttendance()">Tải danh sách</button></div>
      <div class="col"><button style="background:#111827" onclick="exportAllCSV()">Xuất CSV</button></div>
    </div>
    <p class="small">Bạn là admin — xem tất cả bản ghi.</p>

    <table id="attTable">
      <thead><tr><th>Người dùng</th><th>Email</th><th>Thời gian</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // ====== Thay cấu hình Firebase của bạn vào đây ======
    // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDk2dqY_sgL12b1c3XXPMpHjcY6ArYMZNs",
  authDomain: "diem-danh-7b790.firebaseapp.com",
  databaseURL: "https://diem-danh-7b790-default-rtdb.firebaseio.com",
  projectId: "diem-danh-7b790",
  storageBucket: "diem-danh-7b790.firebasestorage.app",
  messagingSenderId: "368662043022",
  appId: "1:368662043022:web:3b6ba571d25688cfc86cdf",
  measurementId: "G-KLFFJE4NMM"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

    // Khởi tạo
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ====== Register: tạo tài khoản + lưu profile (role = 'user') ======
    async function register(){
      const email = document.getElementById('regEmail').value.trim();
      const pass = document.getElementById('regPass').value;
      const name = document.getElementById('regName').value.trim() || email.split('@')[0];
      if(!email || !pass){ alert('Nhập email + mật khẩu'); return; }
      try {
        const userCred = await auth.createUserWithEmailAndPassword(email, pass);
        const uid = userCred.user.uid;
        // lưu profile vào Realtime DB
        await db.ref('users/' + uid).set({
          email: email,
          name: name,
          role: 'user',
          createdAt: Date.now()
        });
        alert('Đăng ký thành công. Bạn đã đăng nhập.');
      } catch(e) {
        alert('Lỗi đăng ký: ' + e.message);
      }
    }

    // ====== Login / Logout ======
    async function login(){
      const email = document.getElementById('logEmail').value.trim();
      const pass = document.getElementById('logPass').value;
      if(!email || !pass){ alert('Nhập email + mật khẩu'); return; }
      try {
        await auth.signInWithEmailAndPassword(email, pass);
      } catch(e){ alert('Lỗi đăng nhập: '+e.message); }
    }
    function logout(){ auth.signOut(); }

    // ====== Auth state change ======
    let currentUser = null;
    auth.onAuthStateChanged(async (user) => {
      currentUser = user;
      document.getElementById('authMsg').textContent = user ? ('Đã đăng nhập: ' + user.email) : 'Chưa đăng nhập';
      if(user){
        // lấy profile từ Realtime DB
        const snap = await db.ref('users/' + user.uid).get();
        const profile = snap.exists() ? snap.val() : { role: 'user', name: user.email };
        showUserUI(profile);
      } else {
        showLoggedOutUI();
      }
    });

    function showUserUI(profile){
      document.getElementById('userBox').style.display = 'block';
      document.getElementById('welcome').textContent = `Xin chào ${profile.name || ''} (${profile.role || 'user'})`;
      if(profile.role === 'admin') document.getElementById('adminBox').style.display = 'block';
      else document.getElementById('adminBox').style.display = 'none';
    }
    function showLoggedOutUI(){
      document.getElementById('userBox').style.display = 'none';
      document.getElementById('adminBox').style.display = 'none';
      document.getElementById('myList').innerHTML = '';
      document.getElementById('attMsg').textContent = '';
    }

    // ====== Điểm danh: push vào /attendance ======
    async function checkIn(){
      if(!currentUser){ alert('Bạn cần đăng nhập'); return; }
      try {
        const ref = db.ref('attendance').push();
        await ref.set({
          uid: currentUser.uid,
          email: currentUser.email,
          name: (await db.ref('users/' + currentUser.uid + '/name').get()).val() || '',
          ts: Date.now()
        });
        document.getElementById('attMsg').textContent = 'Đã điểm danh lúc ' + new Date().toLocaleString();
        myAttendance();
      } catch(e){ alert('Lỗi điểm danh: '+e.message); }
    }

    // ====== Xem lịch sử của chính mình ======
    async function myAttendance(){
      if(!currentUser) return;
      const q = await db.ref('attendance').orderByChild('uid').equalTo(currentUser.uid).limitToLast(100).get();
      const ul = document.getElementById('myList'); ul.innerHTML = '';
      q.forEach(snap => {
        const data = snap.val();
        const t = data.ts ? new Date(data.ts).toLocaleString() : '---';
        const li = document.createElement('li'); li.textContent = t;
        ul.appendChild(li);
      });
    }

    // ====== Admin: load all attendance ======
    async function loadAllAttendance(){
      const tbody = document.querySelector('#attTable tbody'); tbody.innerHTML = '';
      const snap = await db.ref('attendance').orderByChild('ts').limitToLast(10000).get();
      const rows = [];
      snap.forEach(s => {
        rows.push(s.val());
      });
      // rows are in ascending by ts; reverse to show newest first
      rows.reverse().forEach(data => {
        const t = data.ts ? new Date(data.ts).toLocaleString() : '---';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${data.name||''}</td><td>${data.email||''}</td><td>${t}</td>`;
        tbody.appendChild(tr);
      });
    }

    // ====== Export CSV ======
    async function exportAllCSV(){
      const snap = await db.ref('attendance').orderByChild('ts').get();
      const rows = [['name','email','timestamp']];
      snap.forEach(s => {
        const d = s.val();
        rows.push([d.name||'', d.email||'', d.ts ? new Date(d.ts).toISOString() : '']);
      });
      const csv = rows.map(r => r.map(c => `"${(c||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'attendance.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // ====== Notes ======
    // To make someone admin: in Realtime Database set /users/{uid}/role = "admin"
    // Database structure:
    // /users/{uid} => { email, name, role, createdAt }
    // /attendance/{pushId} => { uid, email, name, ts }

  </script>
</body>
</html>
